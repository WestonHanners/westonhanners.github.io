<!DOCTYPE html>
<html lang="en">
<head>
<!-- Made with Liquid -->
<meta charset=""/>
<base href="/"/>
<title> Easy, Automatic Server Mocking for iOS Testing | alloc-init</title>


<meta name="description" content="<blockquote>
  <p>What do you do when you need to run UI tests on an integration server
for an app that requires a VPN to reach its web service?</p>
</blockquote>

" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@westonhanners"/>
<meta name="twitter:creator" content="@westonhanners"/>
<meta property="og:type" content="article"/>
<meta property="og:title" content=" Easy, Automatic Server Mocking for iOS Testing |  alloc-init"/>
<meta property="og:description" content="<blockquote>
  <p>What do you do when you need to run UI tests on an integration server
for an app that requires a VPN to reach its web service?</p>
</blockquote>

"/>
<meta property="og:url" content="http://alloc-init.com//blog/2016.06.27"/>
<meta property="og:site_name" content="alloc-init"/>
<meta property="fb:admins" content="weston.hanners"/>
<meta property="og:image" content="images/logo-v3-1000x1000.png" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="test/assets/css/main.css, " type="text/css"/>
<link rel="icon" href="images/logo-v3-16x16.png" sizes="16x16" />
<link rel="icon" href="images/logo-v3-32x32.png" sizes="32x32" />
<link rel="icon" href="images/logo-v3-192x192.png" sizes="192x192" />
<link rel="apple-touch-icon-precomposed" href="images/logo-v3-180x180.png" />
</head>

<body>
<header class="header">
  <div class="banner">
	<a href="./">
	...alloc] init];
	</a>
</div>
<div class="navcontainer">
<div id="topnav" class="navitems">
<a href="./">[Home]</a>
<a href="./about">[about me]</a>
<a href="./resources">[resources]</a>
<a href="./stuff">[stuff]</a>
<a href="./posts">[posts]</a>
<a href="https://twitter.com/WestonHanners">[Twitter]</a>
<a href="https://github.com/WestonHanners">[Github]</a>
</div>

<div class="icon">
	<a href="javascript:void(0);" onclick="toggleNav()">&#9776;</a>
</div>

</div>
</header>
<section class="content">
  <article>
  <h1 class="article-title">Easy, Automatic Server Mocking for iOS Testing</h1>
  
  <h4 class="date-line">Published on Jun 27th, 2016</h4>
  
  <blockquote>
  <p>What do you do when you need to run UI tests on an integration server
for an app that requires a VPN to reach its web service?</p>
</blockquote>

<p>This was a question that I needed an answer for earlier this week. My
first thought was to try to stub out the service calls with dummy data
and bundle it with my app, but this was going to need a lot of work to
maintain and I am pretty lazy. After an hour or so of research, I came
upon <a href="https://mitmproxy.org">mitmproxy</a>. Here is the solution…</p>

<h2 id="project-configuration">Project Configuration</h2>

<p>First set up a new project configuration and call it something like
“Mock” In your app’s target build settings, find the section called
“Other Swift Flags”. Twirl down the arrow and add “-D MOCKING” next to
your mocking configuration. This works similarly to preprocessor macros
in Objective-C, and will allow you to set up code that will only be
compiled when it is defined. Hopefully you are using NSURLSession for
your API calls, find the place where you initialize it and set its
configuration like this.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#if MOCKING

let proxyDict: [AnyHashable: Any] = [
    "HTTPSEnable"   :1,
    "HTTPSProxy"    :"localhost",
    "HTTPSPort"     :8080,
    "HTTPEnable"    :1,
    "HTTPProxy"     :"localhost",
    "HTTPPort"      :8080
]

URLSession.configuration.connectionProxyDictionary = proxyDict

#endif
</code></pre></div></div>

<p>This will redirect your http and https requests made with that session
through your local proxy.</p>

<h2 id="install-and-configure-mitmproxy">Install and Configure mitmproxy</h2>

<p>Now you are ready to install mitmproxy. <code class="highlighter-rouge">brew install mitmproxy</code>. After
installing, run it once from the terminal to make sure everything works.
This will also install a certificate into ~/.mitmproxy.</p>

<p>Clone <a href="https://github.com/ADVTOOLS/ADVTrustStore.git">this repository</a> somewhere.</p>

<p>This tool will install the certificate into your simulators. Run this
command:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./iosCertTrustManager.py -a ~/.mitmproxy/mitmproxy-ca-cert.pem
</code></pre></div></div>

<p>You will have to enter “y” for any of the simulators you want to use.
Now comes the moment of truth. Run mitmproxy again and start-up your
app. Requests should appear in the window.</p>

<p><img src="images/Screenshot-2016-06-24-20.25.03.png" alt="Recording" /></p>

<p>SUCCESS!!!</p>

<h2 id="start-recording">Start Recording</h2>

<p>Finally we can start recording, when you are ready, run this command.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mitmdump -w output_file_name
</code></pre></div></div>

<p>You can name the output file whatever you want. Once it is running, do
any actions you want to record in the Simulator, and they will be saved
to that file.</p>

<p><img src="images/Screenshot-2016-06-24-20.26.41.png" alt="Playback" /></p>

<p>Press CTRL+C when you are done. Now when you want to replay the
responses you saved, run this command.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mitmdump -S saved_file
</code></pre></div></div>

<p>If your server is uses https, you can prevent mitmdump from trying to
check the certificates during replay by adding the option
“–no-upstream-cert”. You will now be able to run your app, even if you
have no internet connection. This works especially well for UI testing
since your requests are not likely to differ between runs. …and that’s
it. I hope you find this useful, and if you have any questions, feel
free to poke me on <a href="https://twitter.com/@westonhanners">twitter</a>.</p>


  </article>
</section>
<script type="text/javascript" async defer src="/js/navigation.min.js"></script>
<script type="text/javascript" async defer src="/js/asyncyoutube.min.js"></script>

<div class="footer">
    [ ©2019 <a href="http://twitter.com/@WestonHanners">Weston Hanners</a> | <a href="https://alloc-init.com/feed">rss</a> ]
</div>
<!--Powered by Jekyll and Amazon Lightsail, Alloc Theme by Weston Hanners-->

</body>
</html>
